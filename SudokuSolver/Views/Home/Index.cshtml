@model SudokuSolver.Models.SudokuViewModel

@{
    ViewData["Title"] = "Home";
}

<div class="text-center">
    <h1 class="display-4">Sudoku Solver</h1>

    <div class="my-4">
        <span>Carica un esempio:</span>
        <a asp-controller="Home" asp-action="Index" asp-route-difficulty="facile" class="btn btn-success">Facile</a>
        <a asp-controller="Home" asp-action="Index" asp-route-difficulty="medio" class="btn btn-warning">Medio</a>
        <a asp-controller="Home" asp-action="Index" asp-route-difficulty="difficile" class="btn btn-danger">Difficile</a>
    </div>

    <div style="margin-top: 25px;">
        <form method="post" asp-controller="Home" asp-action="Index" id="sudoku-form">
            <div class="sudoku-container">
                @for (int i = 0; i < 9; i++)
                {
                    <div class="sudoku-row">
                        @for (int j = 0; j < 9; j++)
                        {
                            <input asp-for="Grid[i][j].Value"
                                   class="sudoku-cell @(Model.Grid[i][j].IsOriginal ? "original-number" : "solved-number")"
                                   type="text"
                                   data-row="@i"
                                   data-col="@j"
                                   oninput="this.value = this.value.replace(/[^1-9]/g, '').slice(0, 1)"
                                   autocomplete="off"
                                   readonly="@(Model.Grid[i][j].IsOriginal ? "readonly" : null)" />
                        }
                    </div>
                }
            </div>

            @for (int i = 0; i < 9; i++)
            {
                @for (int j = 0; j < 9; j++)
                {
                    <input type="hidden" asp-for="Grid[i][j].IsOriginal" />
                }
            }

            <div style="margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 10px;">

                <button type="submit" class="btn btn-primary btn-lg" id="solve-button">
                    Risolvi
                </button>

                <button type="button" class="btn btn-info btn-lg text-white" id="hint-button"
                        data-bs-toggle="tooltip" data-bs-placement="bottom"
                        title="Seleziona una casella vuota per scoprire il numero, oppure clicca qui per un aiuto casuale.">
                    Aiuto
                </button>

                <button type="button" class="btn btn-secondary btn-lg" id="reset-button">
                    Azzera
                </button>

            </div>

        </form>

        @if (ViewData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger mt-3" role="alert">
                @ViewData["ErrorMessage"]
            </div>
        }

        @if (ViewData["SuccessMessage"] != null)
        {
            <div class="alert alert-success mt-3" role="alert">
                @ViewData["SuccessMessage"]
            </div>
        }
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        const solveButton = document.getElementById('solve-button');
        const hintButton = document.getElementById('hint-button');
        const resetButton = document.getElementById('reset-button');
        const sudokuForm = document.getElementById('sudoku-form');
        const cells = document.querySelectorAll('.sudoku-cell');

        function updateButtonsState() {
            let isFull = true;
            cells.forEach(cell => {
                if (cell.value === '') {
                    isFull = false;
                }
            });

            const successAlert = document.querySelector('.alert-success');
            const isServerCompleted = successAlert !== null;

            if (isServerCompleted) {
                solveButton.disabled = true;
                solveButton.innerHTML = "Completato!";
                solveButton.classList.remove('btn-primary');
                solveButton.classList.add('btn-success');

                hintButton.disabled = true; 
            }
            else if (isFull) {
                solveButton.disabled = false;
                solveButton.innerHTML = "Verifica";
                solveButton.classList.remove('btn-primary');
                solveButton.classList.add('btn-success'); 

                hintButton.disabled = true; 
            }
            else {
                solveButton.disabled = false;
                solveButton.innerHTML = "Risolvi";
                solveButton.classList.add('btn-primary');
                solveButton.classList.remove('btn-success');

                hintButton.disabled = false; 
            }
        }

        updateButtonsState();

        cells.forEach(cell => {
            cell.addEventListener('input', function() {
                updateButtonsState();
            });
        });

        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                delay: { "show": 1000, "hide": 100 }
            })
        })

        let lastSelectedRow = null;
        let lastSelectedCol = null;

        cells.forEach(cell => {
            cell.addEventListener('focus', function() {
                if (!this.hasAttribute('readonly')) {
                    lastSelectedRow = this.getAttribute('data-row');
                    lastSelectedCol = this.getAttribute('data-col');
                } else {
                    lastSelectedRow = null;
                    lastSelectedCol = null;
                }
            });
        });

        sudokuForm.addEventListener('submit', function(e) {
            solveButton.disabled = true;
            solveButton.innerHTML = '<span class="spinner"></span>';
        });

        hintButton.addEventListener('click', function() {
            const originalText = hintButton.innerHTML;
            hintButton.disabled = true;
            hintButton.innerHTML = '<span class="spinner"></span>';

            let gridData = [];
            const rows = document.querySelectorAll('.sudoku-row');
            rows.forEach((row) => {
                let rowData = [];
                const inputs = row.querySelectorAll('input[type="text"]');
                inputs.forEach((input) => {
                    let val = input.value === '' ? null : parseInt(input.value);
                    rowData.push({
                        Value: val,
                        IsOriginal: input.classList.contains('original-number')
                    });
                });
                gridData.push(rowData);
            });

            const payload = {
                Grid: gridData,
                TargetRow: lastSelectedRow ? parseInt(lastSelectedRow) : null,
                TargetCol: lastSelectedCol ? parseInt(lastSelectedCol) : null
            };

            fetch('/Home/GetHint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const targetInput = document.querySelector(`input[data-row="${data.rowIndex}"][data-col="${data.colIndex}"]`);
                    if (targetInput) {
                        targetInput.value = data.value;
                        targetInput.classList.remove('original-number');
                        targetInput.classList.add('solved-number');
                        targetInput.style.backgroundColor = '#fff3cd';
                        setTimeout(() => targetInput.style.backgroundColor = '', 1000);

                        lastSelectedRow = null;
                        lastSelectedCol = null;
                        targetInput.blur();

                        updateButtonsState();
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Errore:', error))
    .finally(() => {
                    hintButton.innerHTML = 'Aiuto';
                    hintButton.disabled = false;
                    updateButtonsState();
                });
        });

        resetButton.addEventListener('click', function() {
            const cells = document.querySelectorAll('.sudoku-cell');
            cells.forEach(cell => {
                cell.value = '';
                cell.classList.remove('original-number');
                cell.classList.add('solved-number');
                cell.removeAttribute('readonly');
            });
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => alert.remove());

            lastSelectedRow = null;
            lastSelectedCol = null;

            updateButtonsState();
        });
    });
</script>